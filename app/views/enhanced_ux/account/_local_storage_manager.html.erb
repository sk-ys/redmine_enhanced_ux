<!--
// Path pattern:       /my/account
// Insertion position: Head of all pages
// Type:               HTML
// Comment:            Local Storage manager
-->
<script>
  window.addEventListener("DOMContentLoaded", () => {
    const resourcesAll = {
      en: {
        labelLocalStorageManager: "Local storage manager",
        labelKey: "Key",
        labelValue: "Value",
        labelRemove: "Remove",
        labelRemoveAll: "Remove all",
        messageAreYouSure: "Are you sure?",
      },
      ja: {
        labelLocalStorageManager: "ローカルストレージの管理",
        labelKey: "キー",
        labelValue: "値",
        labelRemove: "削除",
        labelRemoveAll: "すべて削除",
        messageAreYouSure: "よろしいですか？",
      },
    };

    const resources =
      resourcesAll[document.documentElement.lang] || resourcesAll["en"];

    const homeUrl =
      ["login", "logout"]
        .map(
          (key) =>
            $("." + key)
              .attr("href")
              ?.split(key)[0]
        )
        .filter((i) => i)[0] || "/";
    const svgIcons = new (class SVGIcons {
      constructor() {
        const extractedPath = this.#extractIconPath();
        this.basePath = extractedPath ? homeUrl + extractedPath : null;
      }
      #extractIconPath() {
        const $elem = $("use[href*='/assets/icons-'][href*='.svg#']").first();
        const match = $elem
          .attr("href")
          ?.match(/\/(assets\/icons-[a-f0-9]+\.svg)#/);
        return match ? match[1] : null;
      }
      generateSvgIconTag(key) {
        if (!this.basePath) return null;
        return $(
          `<svg class="s18 icon-svg" aria-hidden="true">` +
            `<use href="${this.basePath}#${key}"></use>` +
            `</svg>`
        );
      }
      get settings() {
        return this.generateSvgIconTag("icon--settings");
      }
      get del() {
        return this.generateSvgIconTag("icon--del");
      }
    })();

    function drawLocalStorageItemList() {
      const $tableOuter = $("<div>").addClass("table-outer");
      const $table = $("<table>")
        .append(
          $("<thead>").append(
            $("<tr>")
              .append($("<th>").addClass("key-column").text(resources.labelKey))
              .append(
                $("<th>").addClass("value-column").text(resources.labelValue)
              )
              .append(
                $("<th>")
                  .addClass("remove-action-column")
                  .text(resources.labelRemove)
              )
          )
        )
        .append($("<tbody>"))
        .appendTo($tableOuter);

      Object.entries(localStorage)
        .sort(([keyA], [keyB]) => keyA.localeCompare(keyB))
        .forEach(([key, value]) => {
          const $removeLink = $("<a>")
            .addClass("icon icon-del icon-only")
            .on("click", (e) => {
              if (confirm(resources.messageAreYouSure)) {
                removeItem(e.currentTarget);
                drawLocalStorageItemList();
              }
            });

          if (svgIcons.del) {
            $removeLink.append(svgIcons.del);
          }
          $table
            .find("tbody")
            .append(
              $("<tr>")
                .append($("<td>").addClass("key-column").text(key))
                .append($("<td>").addClass("value-column").text(value))
                .append(
                  $("<td>").addClass("remove-action-column").append($removeLink)
                )
            );
        });

      $listBox.empty().append($tableOuter);
    }

    function removeItem(elem) {
      try {
        const key = $(elem).closest("tr").find("td.key-column").text();
        localStorage.removeItem(key);
      } catch (e) {
        console.warn(e);
      }
    }

    const $removeAllButton = $("<a>")
      .addClass("icon icon-del remove-all-button")
      .text(resources.labelRemoveAll)
      .on("click", () => {
        if (confirm(resources.messageAreYouSure)) {
          localStorage.clear();
          drawLocalStorageItemList();
        }
      });
    if (svgIcons.del) {
      $removeAllButton.prepend(svgIcons.del);
    }
    const $contextual = $("<div>")
      .addClass("contextual")
      .append($removeAllButton);
    const $listBox = $("<div>").addClass("box list-box");
    const $localStorageManager = $("<div>")
      .append($contextual)
      .append($listBox);

    function initDialog() {
      $localStorageManager.dialog({
        autoOpen: false,
        modal: true,
        title: resources.labelLocalStorageManager,
        draggable: false,
        resizable: false,
        open: function () {
          drawLocalStorageItemList();
        },
        create: function () {
          $(this).parent().attr("id", "localStorageManager");
        },
      });
    }

    const $menu = $("<a>")
      .text(resources.labelLocalStorageManager)
      .addClass("icon icon-settings prevent-popup-anywhere")
      .css("cursor", "pointer")
      .on("click", () => {
        console.log("");
        $localStorageManager.dialog("open");
      });
    if (svgIcons.settings) {
      $menu.prepend(svgIcons.settings);
    }

    function initialize() {
      $("#content > div.contextual").prepend($menu);
      initDialog();
    }

    initialize();
  });
</script>
<style>
  #localStorageManager {
    width: min(1200px, calc(100vw - 40px)) !important;
    height: calc(100vh - 40px) !important;
    display: flex;
    flex-direction: column;

    .ui-dialog-content {
      display: flex;
      flex-direction: column;
      align-items: flex-end;

      .contextual {
        padding-right: 7px;
      }

      .list-box {
        overflow: auto;
        width: 100%;
        height: 100%;
        box-sizing: border-box;
        margin: 0;

        .table-outer {
          overflow: auto;
          width: 100%;
          height: 100%;
          padding: 0;

          table {
            word-break: break-all;
            border-collapse: collapse;
            width: 100%;

            thead {
              position: sticky;
              top: 0;
              background-color: #ddd;

              th {
                &.key-column {
                  width: 200px;
                }
                &.remove-action-column {
                  width: 80px;
                }
              }
            }
            tbody {
              tr {
                &:hover {
                  background-color: #eee;
                }

                td {
                  border: 1px solid #ddd;

                  &.remove-action-column {
                    text-align: center;
                  }
                }
              }
            }
          }
        }
      }

      .remove-action-column a.icon-del,
      a.icon-del.remove-all-button {
        cursor: pointer;
      }
    }
  }
</style>
