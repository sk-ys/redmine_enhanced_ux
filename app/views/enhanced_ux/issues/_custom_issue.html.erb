<!-- 
// Path pattern:       /issues/[0-9]+$
// Insertion position: Head of all pages
// Type:               HTML
// Comment:            Custom issue
  -->
<script>
  var ajaxUpdateIssueList;

  window.addEventListener("DOMContentLoaded", function () {
    // ----- settings start -----
    const dialogBaseConfig = {
      minWidth: 400,
      minHeight: 200,
    };
    const notesDialogBaseConfig = {
      width: 750,
      height: 520,
    };

    const defaultSettings = {
      isDescriptionEditFieldOpenByDefault: true,
      enableAddChildIssueDialog: true,
      enableEditAttachmentsDialog: true,
      enableTimeEntryDialog: true,
      enableIssueTabView: true,
      enableSideBySideMode: true,
      enablePopupNotes: true,
      enableInlineNotes: true,
      enableFloatingSubmitButton: true,
      enableResizableAttachmentTable: true,
      enableCorrectAttributesPositionInEditView: true,
      sideBySideModeBreakpointWidth: 1280,
    };

    // ----- settings end -----

    // i18n
    const resourcesAll = {
      en: {
        sideBySideMode: "Side-by-side mode",
        labelView: "View",
        labelEdit: "Edit",
        labelAddQuickNotes: "Add quick notes",
        labelCancel: "Cancel",
        labelFixed: "Fixed",
        labelUnfixed: "Unfixed",
        labelAddChildIssue: "Add child issue",
        labelPopOut: "Pop-out",
        labelRestore: "Restore",
        labelMaximize: "Maximize",
        labelClose: "Close",
        messageSubmitAll:
          "⚠️Sends all changes in the edit fields, quick notes fields, " +
          "and attachments, and then reloads the page.",
        labelSubmitAll: "Submit all",
        labelSubmitQuickNotesWithAttachments:
          "Submit quick notes with attachments",
        titleSubmitNotes: "Note: Attachments are sent at the same time",
        confirmResetWidth: "Do you want to reset the width?",
        helpSideBySideMode:
          "Display the history column to the right of the issue description " +
          "column.",
        labelQuickNotes: "Quick notes",
        closeQuickNotes: "Close quick notes",
        labelSwitchQuickNotesPosition: "Switch quick notes position",
        messageFailedToSend: "Failed to send",
        messageDisplayNotesFieldHere: "Display the notes field here",
        messageQuickNotesWillBeClosed: "⚠️The quick notes will be closed",
        labelCustomIssueViewSettings: "Custom Issue View Settings",
        labelIssueViewSettings: "Issue View Settings",
        labelSaveAndReload: "Save and Reload",
        labelSettingIsDescriptionEditFieldOpenByDefault:
          "Show description edit field open by default",
        labelSettingEnableAddChildIssueDialog:
          "Enable 'Add Child Issue' dialog",
        labelSettingEnableEditAttachmentsDialog:
          "Enable 'Edit Attachments' dialog",
        labelSettingEnableTimeEntryDialog: "Enable 'Time Entry' dialog",
        labelSettingEnableIssueTabView: "Enable issue tab view",
        labelSettingEnableSideBySideMode: "Enable side-by-side mode",
        labelSettingEnablePopupNotes: "Enable popup notes",
        labelSettingEnableInlineNotes: "Enable inline notes",
        labelSettingEnableFloatingSubmitButton: "Enable floating submit button",
        labelSettingEnableResizableAttachmentTable:
          "Enable resizable attachment table",
        labelSettingEnableCorrectAttributesPositionInEditView:
          "Enable correct attributes position in edit view",
        labelSettingSideBySideModeBreakpointWidth:
          "Minimum screen width for side-by-side mode",
        messageSettingEnableSideBySideMode:
          "⚠️To enable side-by-side mode, issue tab view must be enabled",
      },
      ja: {
        sideBySideMode: "左右に並べて表示",
        labelView: "表示",
        labelEdit: "編集",
        labelAddQuickNotes: "クイックコメントの追加",
        labelCancel: "キャンセル",
        labelFixed: "固定",
        labelUnfixed: "固定解除",
        labelAddChildIssue: "子チケットの追加",
        labelPopOut: "ポップアウト",
        labelMaximize: "最大化",
        labelClose: "閉じる",
        labelRestore: "元の場所に戻す",
        messageSubmitAll:
          "⚠️編集欄、クイックコメント欄、添付ファイルの変更内容の全てを送信し、" +
          "ページを再読み込みします。",
        labelSubmitAll: "全てを送信",
        labelSubmitQuickNotesWithAttachments:
          "クイックコメントと添付ファイルを送信",
        confirmResetWidth: "幅をリセットしますか？",
        helpSideBySideMode: "履歴欄をチケット説明欄の右隣に表示します。",
        labelQuickNotes: "クイックコメント",
        closeQuickNotes: "クイックコメントを閉じる",
        labelSwitchQuickNotesPosition: "クイックコメントの位置を切り替え",
        messageFailedToSend: "送信に失敗しました",
        messageDisplayNotesFieldHere: "コメント欄をここに表示する",
        messageQuickNotesWillBeClosed: "⚠️クイックコメント欄は閉じられます",
        labelCustomIssueViewSettings: "カスタムチケット表示設定",
        labelIssueViewSettings: "チケット表示設定",
        labelSaveAndReload: "保存して再読み込み",
        labelSettingIsDescriptionEditFieldOpenByDefault:
          "説明編集欄をデフォルトで開いた状態にする",
        labelSettingEnableAddChildIssueDialog:
          "「子チケットの追加」ダイアログを有効にする",
        labelSettingEnableEditAttachmentsDialog:
          "「添付ファイルの編集」ダイアログを有効にする",
        labelSettingEnableTimeEntryDialog:
          "「時間を記録」ダイアログを有効にする",
        labelSettingEnableIssueTabView: "チケットタブ表示を有効にする",
        labelSettingEnableSideBySideMode: "左右に並べて表示を有効にする",
        labelSettingEnablePopupNotes: "ポップアップコメントを有効にする",
        labelSettingEnableInlineNotes: "インラインコメントを有効にする",
        labelSettingEnableFloatingSubmitButton: "送信ボタンを固定する",
        labelSettingEnableResizableAttachmentTable:
          "添付ファイル欄をリサイズ可能にする",
        labelSettingEnableCorrectAttributesPositionInEditView:
          "編集画面の項目の位置を修正する",
        labelSettingSideBySideModeBreakpointWidth:
          "左右に並べて表示する最小の画面幅",
        messageSettingEnableSideBySideMode:
          "⚠️左右に並べて表示を有効にするにはチケットタブ表示を有効にする必要があります",
      },
    };
    const resources = {
      ...resourcesAll["en"],
      ...(resourcesAll[document.documentElement.lang] || {}),
    };
    const isRtl = $('head link[rel="stylesheet"][href*="/rtl"]').length > 0;
    const isMac = navigator.platform.indexOf("Mac") !== -1;
    const issuePathname = location.pathname;
    const issueUrl = location.origin + location.pathname;
    const issueEditUrl = issueUrl + "/edit";
    const issueId = Number(location.pathname.match(/([0-9]+)\/{0,1}$/)[1]);
    const isEditable = $("#update").length !== 0;
    const issueNotesTextareaRowsDefault = $("#issue_notes").attr("rows");
    const addNotesLegendDefault = $("#add_notes>legend:first").text();
    const $submitButton = $('#issue-form input[type="submit"]');
    const $history = $("#history");
    const enableRedmineRT = $("#quick_notes").length > 0;
    let notesManager = null;
    let issueLayoutManager = null;

    // Utils
    function detectHistoryDirection() {
      if (enableRedmineRT) {
        return $history.data("comment_sorting") === "desc" ? "desc" : "asc";
      }

      const journals = $("#tab-content-history > .journal");
      if (journals.length > 1) {
        return journals
          .map((i, e) => parseInt(e.id.split("-")[1]))
          .toArray()
          .every((v, i, arr) => i === 0 || arr[i - 1] <= v)
          ? "asc"
          : "desc";
      }

      // Default direction
      return "asc";
    }

    // Issue layout manager class
    class IssueLayoutManager {
      constructor(
        enableTabView,
        enableSideBySideMode,
        enableFloatingSubmitButton,
        enableResizableAttachmentTable,
        enableCorrectAttributesPositionInEditView,
        isDescriptionEditFieldOpenByDefault,
        sideBySideModeBreakpointWidth
      ) {
        this.tabViewEnabled = enableTabView ?? true;
        this.sideBySideModeEnabled = enableSideBySideMode ?? true;
        this.floatingSubmitButtonEnabled = enableFloatingSubmitButton ?? true;
        this.resizableAttachmentTableEnabled =
          enableResizableAttachmentTable ?? true;
        this.correctAttributesPositionInEditViewEnabled =
          enableCorrectAttributesPositionInEditView ?? true;
        this.isDescriptionEditFieldOpenByDefault =
          isDescriptionEditFieldOpenByDefault ?? true;
        this.sideBySideModeBreakpointWidth =
          sideBySideModeBreakpointWidth ?? 1280;
        this.hasHistoryData = $("#history>p.nodata").length === 0;

        $("#update").prev().addClass("update-prev-marker");

        if (this.tabViewEnabled) {
          $("#content").addClass("issue-tab-view-enabled");

          this.#setupTabs();
          this.selectIssueTab();

          if (this.sideBySideModeEnabled && this.hasHistoryData) {
            this.#setupSideBySideMode();
          }
        } else {
          // Add event to cancel link
          $("form.edit_issue input[type=submit]+a").on("click", (e) => {
            // Redraw dialog if already open
            if (notesManager?.dialogNotes?.isOpen()) {
              notesManager.dialogNotes.close();
              this.resetForm();
              notesManager.dialogNotes.open();

              // TODO: Height cannot be adjusted in just one run. Unexplained.
              notesManager.dialogNotes.close();
              this.resetForm();
              notesManager.dialogNotes.open();
            }
          });
        }

        this.#setupCustomAttachmentTable();
        if (isEditable) {
          this.#setupCorrectAttributesPositionInEditView();
          this.#setupFloatingSubmitButton();
          this.#setupShowDescriptionEditFieldOpenByDefault();
        }

        this.#setupFormChangeDetection();
      }

      sideBySideProperty = {
        get enabled() {
          return localStorage.getItem("side-by-side-enabled") === "true";
        },
        set enabled(value) {
          localStorage.setItem("side-by-side-enabled", value);
        },
        get issueContainerWidth() {
          return localStorage.getItem("side-by-side-issue-container-width");
        },
        set issueContainerWidth(value) {
          localStorage.setItem("side-by-side-issue-container-width", value);
        },
      };

      #generateTabViewRelatedElements() {
        this.$container = $("<div>").attr("id", "container");
        this.$issueContainer = $("<div>")
          .attr("id", "issue-container")
          .resizable({
            handles: isRtl ? "w" : "e",
            create: function () {
              $(this)
                .children(".ui-resizable-handle")
                .on("dblclick", () => {
                  if (confirm(resources.confirmResetWidth)) {
                    this.$issueContainer.css("width", "");
                    this.sideBySideProperty.issueContainerWidth = null;
                  }
                });
            },
          });
        this.$issueTabs = $("<div>").addClass("tabs").append("<ul>");
        this.$issueTabView = $("<li>").append(
          $("<a>")
            .html(resources.labelView)
            .attr({
              id: "tab-issue-view",
              href: issueUrl,
            })
            .on("click", (e) => {
              getRemoteTab("view", issueUrl, issueUrl, true);
              e.preventDefault();
              e.stopPropagation();
            })
            .addClass("selected")
        );
        this.$issueTabEdit = !isEditable
          ? null
          : $("<li>").append(
              $("<a>")
                .text(resources.labelEdit)
                .attr({
                  id: "tab-issue-edit",
                  href: issueEditUrl,
                })
                .on("click", (e) => {
                  getRemoteTab(
                    "edit",
                    issueUrl + "/edit",
                    issueUrl + "?tab=edit",
                    true
                  );
                  e.preventDefault();
                  e.stopPropagation();

                  this.resetForm();
                })
            );
      }

      #generateSideBySideModeRelatedElements() {
        this.$toggleSwitch = $('<input type="checkbox">')
          .attr({
            type: "checkbox",
            id: "enableSideBySideMode",
          })
          .on("click", (e) => {
            this.$toggleSwitch.check($(e.currentTarget).is(":checked"));
          });
        this.$switchBox = $("<div>")
          .append(this.$toggleSwitch)
          .append(
            $("<label>")
              .attr({ for: "enableSideBySideMode" })
              .html(resources.sideBySideMode)
          )
          .attr({ title: resources.helpSideBySideMode });

        // Define check method
        this.$toggleSwitch.check = (state = true) => {
          if (state === true) {
            $("#wrapper").addClass("side-by-side");
            this.$issueContainer.css(
              "width",
              this.sideBySideProperty.issueContainerWidth
            );
          } else {
            $("#wrapper").removeClass("side-by-side");
            this.$issueContainer.css("width", "");
          }
          this.$toggleSwitch.prop("checked", state);
          this.sideBySideProperty.enabled = state;
          this.updateSubmitButtonPosition();
        };
      }

      #setupTabs() {
        // [Original structure]
        // #content
        // ├─ div.issue.details
        // ├─ #update
        // └─ #history
        //
        // [Structure after tabbed]
        // #content
        // └─ #container
        //       ├─ #issue-container
        //       │    ├─ .tabs
        //       │    │    └─ ul
        //       │    │         ├─ #tab-issue-view
        //       │    │         └─ #tab-issue-edit
        //       │    ├─ div.issue.details
        //       │    └─ #update
        //       └─ #history-container
        //             ├─ #history
        //             ├─ #quick_notes2
        //             └─ #quick_notes(by Redmine RT, always hidden)
        this.#generateTabViewRelatedElements();

        this.$container.insertBefore($("div.issue.details"));

        this.$issueTabs
          .children("ul")
          .append(this.$issueTabView)
          .append(this.$issueTabEdit);
        this.$issueContainer
          .append(this.$issueTabs)
          .append($("div.issue.details"))
          .append($("#update"));

        this.$historyContainer = $("<div>")
          .attr("id", "history-container")
          .append($history);

        this.$container
          .append(this.$issueContainer)
          .append(this.$historyContainer);

        // Set select event to tabs of issue
        this.$issueTabs.find("a").on("click", this.selectIssueTab.bind(this));

        // Replace edit link actions
        $(`#content>.contextual>a[href$="/issues/${issueId}/edit"]`)
          .removeAttr("onclick")
          .on("click", (e) => {
            if (e.ctrlKey) {
              notesManager?.enableDialogNotes(true);
            } else {
              this.resetForm();
              this.selectIssueTab(e, false);
              $("html, body").animate({ scrollTop: 0 }, "slow");
            }
            e.preventDefault();
            e.stopPropagation();
          })
          .addClass("prevent-popup-anywhere");

        // Add event to cancel link
        $("form.edit_issue input[type=submit]+a").on("click", (e) => {
          this.$issueTabView.click();
          e.preventDefault();
          e.stopPropagation();
        });

        // Set up mutation observer for div.issue.details
        // and hide div.issue.details when edit mode
        new MutationObserver(function (mutations) {
          if (!$("#tab-issue-edit").hasClass("selected")) return;
          mutations.forEach((mutation) => {
            Array.from(mutation.addedNodes)
              .filter((addedNode) => $(addedNode).is(".issue.details"))
              .forEach((addedNode) => $(addedNode).hide());
          });
        }).observe($("#issue-container")[0], {
          attributes: false,
          childList: true,
          subtree: false,
        });
      }

      #setupSideBySideMode() {
        // Caution: Need tab view enabled for side-by-side mode

        this.#generateSideBySideModeRelatedElements();

        this.$switchBox
          .attr("id", "side-by-side-switch-box")
          .insertBefore($("#container"));

        this.applySideBySideModeBreakpointWidth();

        if (this.sideBySideProperty.enabled) {
          this.$toggleSwitch.check();
        }

        // Add ResizeObserver to issue-container and save the width of
        // issue-container
        new ResizeObserver((mutations) => {
          this.applySideBySideModeBreakpointWidth();
          if (
            this.$switchBox.is(":visible") &&
            $("#wrapper").hasClass("side-by-side")
          ) {
            this.sideBySideProperty.issueContainerWidth =
              mutations[0].target.clientWidth;
          }
        }).observe(this.$issueContainer[0], { attributes: true });
      }

      applySideBySideModeBreakpointWidth() {
        if (
          $(window).width() < this.sideBySideModeBreakpointWidth ||
          !this.sideBySideModeEnabled
        ) {
          $("#wrapper.side-by-side-mode-enabled").removeClass(
            "side-by-side-mode-enabled"
          );
        } else {
          $("#wrapper:not(.side-by-side-mode-enabled)").addClass(
            "side-by-side-mode-enabled"
          );
        }
      }

      #setupCustomAttachmentTable() {
        if (!this.resizableAttachmentTableEnabled) return;

        $("#content .attachments > table").addClass("resizable");

        $("#content")
          .on("dblclick", ".attachments > table", () => {
            this.resetHeightOfAttachmentTable();
          })
          .on("mouseover", ".attachments > table", () => {
            const $attachmentsTable = $(".attachments > table");
            if ($attachmentsTable.css("max-height") !== "none") {
              $attachmentsTable.css({
                height: Math.min($attachmentsTable.outerHeight(), 100),
                maxHeight: "none",
              });
            }
          });

        this.resetHeightOfAttachmentTable();
      }

      resetHeightOfAttachmentTable() {
        if (!this.resizableAttachmentTableEnabled) return;

        const $attachmentsTable = $(".attachments > table");
        if ($attachmentsTable.length === 0) return;

        if (!$attachmentsTable.hasClass("resizable")) {
          $attachmentsTable.addClass("resizable");
        }

        $attachmentsTable.css({ height: "", maxHeight: "" });
      }

      resetForm() {
        // Restore Edit form
        if ($("#issue-container #update").length === 0) {
          if (this.tabViewEnabled) {
            $("#update").appendTo("#issue-container");
          } else {
            $("#update").insertAfter(".update-prev-marker:first");
          }
        }

        // Restore notes
        $("#add_notes").appendTo($("#issue-form>.box.filedroplistner:last"));

        // Restore add_attachments
        $("#add_attachments").appendTo(
          $("#issue-form>.box.filedroplistner:last")
        );

        // Restore #issue_notes textarea rows
        $("#issue_notes").attr("rows", issueNotesTextareaRowsDefault);

        // Restore add_notes legend
        $("#add_notes>legend:first").text(addNotesLegendDefault);

        // Reset height for history and quick notes2
        $("#history").css("height", "");
        $("#quick_notes2").css("height", "");

        // Add notes pop-out button
        notesManager?.addNotesDialogPopOutButton();

        // Focus to notes field
        // const scrollTop = $(".edit_issue > .box.filedroplistner").scrollTop();
        // $("#issue_notes")[0].focus();
        // setTimeout(() => {
        //   $(".edit_issue > .box.filedroplistner").scrollTop(scrollTop);
        // });
      }

      // Issue tab selected event
      selectIssueTab(e, isNotesOnlyMode = false) {
        if (!isEditable) {
          this.$issueTabView.children("a").addClass("selected");
          return;
        }

        this.$issueTabs.find("a").removeClass("selected");

        let isEditMode = false;
        if (e === undefined) {
          isEditMode = /tab=edit/.test(location.search);
        } else if ($(e.target).length > 0) {
          isEditMode =
            $(e.target).attr("id") === "tab-issue-edit" ||
            new RegExp(`/issues/${issueId}/edit`).test(
              $(e.target).attr("href")
            );
        }

        (isEditMode ? this.$issueTabEdit : this.$issueTabView)
          .children("a")
          .addClass("selected");

        if (isEditMode) {
          $("div.issue.details").hide();
          $("#update").show();
          // $("#issue_notes")[0].focus();
        } else {
          $("#update").hide();
          $("div.issue.details").show();
        }

        // Redraw dialog if already open
        if (notesManager?.dialogNotes?.isOpen()) {
          notesManager.dialogNotes.close();
          this.resetForm();
          notesManager.dialogNotes.open();

          // TODO: Height cannot be adjusted in just one run. Unexplained.
          notesManager.dialogNotes.close();
          this.resetForm();
          notesManager.dialogNotes.open();
        }

        this.updateSubmitButtonPosition();
        if (!isNotesOnlyMode && $("#update").hasClass("notes-only")) return;
        if (isNotesOnlyMode) $("#issue_notes")[0].focus();
      }

      #setupFloatingSubmitButton() {
        if (this.floatingSubmitButtonEnabled) {
          $("#issue-form").addClass("enable-floating-submit-button");
          $(window)
            .on("scroll", () => {
              this.updateSubmitButtonPosition();
            })
            .on("resize", () => {
              this.updateSubmitButtonPosition();
            });
          $("#issue-form>.box").on("scroll", () => {
            this.updateSubmitButtonPosition();
          });
        }

        this.updateSubmitButtonPosition();
      }

      updateSubmitButtonPosition() {
        if (!this.floatingSubmitButtonEnabled) return;

        const $box = $("#issue-form>div.box").eq(0);
        if (!$submitButton.is(":visible")) return;
        const isOverFlow =
          this.sideBySideProperty.enabled && this.$switchBox?.is(":visible")
            ? $box[0].scrollHeight > $box.outerHeight() + $box.scrollTop()
            : $box.outerHeight() + $box.offset().top >
              $(window).scrollTop() + $(window).height() - 40;
        if (isOverFlow) {
          $submitButton.addClass("fixed-position");
          $(".save-draft-button").addClass("fixed-position");
        } else {
          $submitButton.removeClass("fixed-position");
          $(".save-draft-button").removeClass("fixed-position");
        }
      }

      #setupCorrectAttributesPositionInEditView() {
        if (!this.correctAttributesPositionInEditViewEnabled) return;

        // Replace updateIssueFrom function
        const updateIssueFromOrg = updateIssueFrom;
        updateIssueFrom = (url, el) => {
          return updateIssueFromOrg(url, el).then(() => {
            this.correctAttributesPositionInEditView();
          });
        };

        this.correctAttributesPositionInEditView();
      }

      // Correcting the placement of attributes in the edit view
      correctAttributesPositionInEditView() {
        if (!isEditable) return;
        if (!this.correctAttributesPositionInEditViewEnabled) return;

        // Move hidden attributes to top
        $("#all_attributes")
          .prepend(
            $("#issue_parent_issue_id").parent().addClass("header_attribute")
          )
          .prepend(
            $("#issue_tracker_id")
              .parent()
              .addClass("header_attribute")
              .addClass("header_attribute_float-" + (isRtl ? "right" : "left"))
              .css({ clear: "none" })
          )
          .prepend(
            $("#issue_project_id")
              .parent()
              .addClass("header_attribute")
              .addClass("header_attribute_float-" + (isRtl ? "right" : "left"))
          );

        $("#attributes").css("clear: both");

        // Move subject and is_private checkbox
        $("#all_attributes")
          .prepend(
            $("#issue_subject")
              .parent()
              .addClass("header_attribute")
              .addClass("header_attribute_float-" + (isRtl ? "right" : "left"))
          )
          .prepend(
            $("#issue_is_private")
              .parent()
              .css({ clear: "both", paddingLeft: 0 })
              .addClass("header_attribute")
          );

        // Move estimated_time
        $("#issue_estimated_hours")
          .parent()
          .parent()
          .append($("#issue_estimated_hours").parent());

        // Move description attribute to after the #attributes
        const $descriptionAttribute = $(
          "label[for=issue_description]"
        ).parent();
        $("div#attributes").after($descriptionAttribute);

        // Add <hr>
        $("#attributes")
          .before($("<hr>"))
          .children(".splitcontent")
          .after($("<hr>"));

        // Fix placement of "assign to me" button
        $("#issue_assigned_to_id").after($("<br>"));
      }

      #setupShowDescriptionEditFieldOpenByDefault() {
        if (!this.isDescriptionEditFieldOpenByDefault) return;

        // Replace updateIssueFrom function
        const updateIssueFromOrg = updateIssueFrom;
        updateIssueFrom = (url, el) => {
          return updateIssueFromOrg(url, el).then(() => {
            setTimeout(() => {
              this.showDescriptionEditField();
            });
          });
        };

        this.showDescriptionEditField();
      }

      showDescriptionEditField() {
        if (!this.isDescriptionEditFieldOpenByDefault) return;

        $("#issue_description_and_toolbar").show();
        const descriptionDrawLink = $("label[for=issue_description]")
          .parent()
          .find("a")
          .eq(0)
          .hide();
      }

      updateFormCore(data, updateHistory = true) {
        // Update csrf-token
        $("head meta[name='csrf-token']").attr(
          "content",
          $("head meta[name='csrf-token']", data).attr("content")
        );

        // Update issue lock version
        $("#issue-form>input#issue_lock_version").val(
          $("#issue-form>input#issue_lock_version", data).val()
        );

        // Update last journal ID
        $("#last_journal_id").val($("#last_journal_id", data).val());

        // Update issue edit form authenticity token
        $("#issue-form input[name=authenticity_token]").val(
          $("#issue-form input[name=authenticity_token]", data).val()
        );

        // Update content history tab
        if (updateHistory) {
          $("#tab-content-history")
            .empty()
            .append($("#tab-content-history", data).children());
          $("#history>.tabs>ul>li>a.selected").click();
        }

        // Update subtasks pane
        $("#issue_tree").empty().append($("#issue_tree", data).children());

        // Update relations pane
        $("#relations").empty().append($("#relations", data).children());

        // Show flash
        const $flash = $("#content > div.flash", data);
        if ($flash.length) {
          $("#content > div.flash").remove();
          $flash.prependTo("#content");
        }
      }

      /**
       * Set up form change detection.
       * This method's purpose is to detect when the issue view is replaced by
       * other plugins like Redmine RT.
       */
      #setupFormChangeDetection() {
        const targetNode = this.tabViewEnabled
          ? $("#issue-container")[0]
          : $("#content")[0];

        if (targetNode) {
          const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
              if (mutation.type === "childList") {
                mutation.addedNodes.forEach((node) => {
                  if (
                    node.nodeType === Node.ELEMENT_NODE &&
                    $(node).is("div.issue.details")
                  ) {
                    this.handleFormReplacement();
                  }
                });
              }
            });
          });

          observer.observe(targetNode, {
            childList: true,
            subtree: true,
            attributes: false,
          });
        }
      }

      handleFormReplacement() {
        console.log("Issue view replacement detected.");
        this.resetHeightOfAttachmentTable();
      }
    }

    // Quick Notes 2
    class QuickNotes2 {
      #$elem = null;
      constructor(enableInlineNotes) {
        this.enableInlineNotes = enableInlineNotes;
        if ($("form.edit_issue").length > 0) {
          this.position =
            detectHistoryDirection() === "desc" ? "top" : "bottom";
          this.#init();
        }
      }
      initialized() {
        return this.#$elem !== null;
      }
      resetHeight() {
        this.#$elem.css("height", "");
      }
      switchPosition(position = null) {
        if (
          (position && position === "top") ||
          (!position && this.position === "bottom")
        ) {
          this.#$elem.insertBefore($history).resizable({
            handles: "s",
            alsoResize: "#quick_notes2 .wiki-preview",
          });
          this.position = "top";
        } else {
          this.#$elem.insertAfter($history);
          this.#$elem.resizable({
            handles: "n",
            alsoResize: "#quick_notes2 .wiki-preview",
          });
          this.position = "bottom";
        }
      }
      show() {
        if (this.initialized()) {
          this.#$elem
            .children("div.box")
            .prepend($("#add_attachments"))
            .prepend($("#add_notes"));
        }
      }
      #init() {
        this.#$elem = $("<form>")
          .attr("id", "quick_notes2")
          .on({
            dragover: dragOverHandler,
            dragleave: dragOutHandler,
            drop: handleFileDropEvent,
            paste: copyImageFromClipboard,
          })
          .append($("<div>").addClass("box filedroplistner"));

        this.switchPosition(this.position);

        const $quickNotes2Buttons = $("<div>")
          .attr("id", "quick_notes2-buttons")
          .appendTo(this.#$elem);

        const $buttonOpenQuickNotes = $("<button>")
          .attr("type", "button")
          .attr("id", "quick_notes2-open-button")
          .text(resources.labelQuickNotes)
          .appendTo($quickNotes2Buttons)
          .on("click", this.enableInlineNotes);

        const $buttonCloseQuickNotes = $("<button>")
          .attr("type", "button")
          .attr("id", "quick_notes2-close-button")
          .text(resources.closeQuickNotes)
          .appendTo($quickNotes2Buttons)
          .on("click", () => {
            issueLayoutManager.resetForm();
            $("#issue_notes")[0].focus();
          });

        const $buttonSubmitNotes = $("<button>")
          .attr("type", "button")
          .attr("id", "quick_notes2-submit-button")
          .text(resources.labelSubmitQuickNotesWithAttachments)
          .on("click", () => {
            asyncAjaxSubmitNotesWithAttachments().then(() => {
              issueLayoutManager.resetForm();
              $("textarea#issue_notes")
                .removeData("changed")
                .removeAttr("data-changed"); // Support for 2-pane mode
            });
          })
          .appendTo($quickNotes2Buttons);

        const $issueFormButtons = $("<div>")
          .attr("id", "issue-form-buttons")
          .appendTo($("#issue-form>.box:first"));

        const $buttonRestoreNotesPane = $("<button>")
          .attr("type", "button")
          .attr("id", "restore-notes-pane-button")
          .text(resources.messageDisplayNotesFieldHere)
          .attr("title", resources.messageQuickNotesWillBeClosed)
          .appendTo($issueFormButtons)
          .on("click", () => {
            issueLayoutManager.resetForm();
            $("#issue_notes")[0].focus();
          });

        const $buttonSwitchPosition = $("<span>")
          .attr({
            id: "switch-quicknotes2-position-button",
            title: resources.labelSwitchQuickNotesPosition,
          })
          .addClass("ui-icon ui-icon-transferthick-e-w")
          .on("click", (e) => {
            e.preventDefault();
            this.switchPosition();
          })
          .appendTo(this.#$elem);

        $submitButton
          .on("click", issueLayoutManager.resetForm)
          .on("mouseenter", () => {
            if ($("#quick_notes2 #add_notes").length > 0) {
              $submitButton.attr("title", resources.messageSubmitAll);
            }
          })
          .tooltip({
            position: { my: "right center", at: "left center" },
            close: (e, ui) => {
              $submitButton.attr("title", "");
            },
          });
      }
    }

    // Dialog classes
    class BaseDialog {
      constructor(config = {}) {
        this.config = {
          ...dialogBaseConfig,
          create: () => this.createEvent(),
          close: () => this.closeEvent(),
          ...config,
        };
        this.$dialog = null;
        this.$dialogRoot = null;
      }
      setupDialog() {}
      instance() {
        return this.$dialog ? this.$dialog.dialog("instance") : null;
      }
      isOpen() {
        return this.$dialog !== null && this.$dialog.dialog("isOpen");
      }
      open(title) {
        this.setupDialog();
        if (title) this.$dialog.dialog("option", "title", title);
        this.$dialog.dialog("open");
      }
      close() {
        if (this.isOpen()) {
          this.$dialog.dialog("close");
        }
      }
      createEvent() {
        setTimeout(() => {
          this.$dialogRoot
            .attr("id", this.dialogId || this.$dialogRoot.attr("id"))
            .addClass("issue-view-customize");
        });
      }
      closeEvent() {
        this.$dialog.dialog("destroy");
        this.$dialog = null;
      }
      resetButtons() {
        this.$dialog.dialog("option", "buttons", []);
      }
      appendButtons(buttons = []) {
        const $dialogButtons = this.$dialog.dialog("option", "buttons");
        this.$dialog.dialog(
          "option",
          "buttons",
          buttons.concat($dialogButtons)
        );
      }
    }

    class IframeDialog extends BaseDialog {
      constructor(config = {}) {
        super(config);
        this.$iframe = null;
        this.url = null;
      }

      open(url, title = null) {
        this.url = url;
        super.open(title);
      }

      createIframe(url) {
        this.$iframe = $("<iframe>")
          .hide()
          .attr("src", url)
          .on("load", () => {
            setTimeout(() => this.onIframeLoad());
          });
      }

      setupDialog() {
        if (this.$dialog !== null) return;

        this.createIframe(this.url);
        this.$dialog = $("<div>").append(this.$iframe).dialog(this.config);
        this.$dialogRoot = this.$dialog.parent();
      }

      onIframeLoad() {
        const $contents = this.$iframe.contents();
        const actionResult = this.isActionCompleted($contents);

        switch (actionResult) {
          case -1:
            // Redirect to another page
            location.href = $contents[0].documentURI;
            return;
          case 1:
            // In progress
            this.onActionProgress($contents);
            break;
          case 2:
            // Completed
            this.onActionComplete($contents);
            return;
        }

        this.setupIframeContent($contents);
      }

      prepareDialog($contents) {}

      createSubmitButtons($contents) {}

      setupIframeContent($contents) {
        this.cleanUpIframeContents($contents);
        this.$iframe[0].contentWindow.onbeforeunload = () => {
          this.$iframe.hide();
        };
        this.prepareDialog($contents);
        this.$iframe.show();
        this.resetButtons();
        this.createSubmitButtons($contents);
      }

      onActionProgress($contents) {}

      onActionComplete($contents) {}

      isActionCompleted($contents) {
        return -1; // -1: redirect, 0: not completed, 1: in progress, 2: completed
      }

      cleanUpIframeContents($contents) {
        // Remove unnecessary elements to simplify the layout
        $contents
          .find(
            "#wrapper>div.flyout-menu, #top-menu, #header, #footer, #sidebar"
          )
          .remove();

        // Remove the sidebar handler (Support for the Hide Sidebar plugin)
        $contents.find("#sidebarHandler").remove();

        // Remove the header from the content
        $contents.find("#content>h2:first").remove();

        // Remove padding and margin from the main element
        $contents.find("#main").css({ padding: 0, margin: 0 });
      }

      resetButtons() {
        this.$dialog.dialog("option", "buttons", [
          {
            text: resources.labelCancel,
            click: () => {
              this.$dialog.dialog("close");
            },
          },
        ]);
      }
    }

    class AddChildIssueDialog extends IframeDialog {
      constructor(config = {}) {
        super({
          title: resources.labelAddChildIssue,
          width: 980,
          height: 750,
          modal: true,
          ...config,
        });
        this.dialogContentType = "issues";
        this.dialogId = "add-child-issue-dialog";
      }

      onActionProgress($contents) {
        ajaxUpdateIssueList();
      }

      onActionComplete($contents) {
        ajaxUpdateIssueList();
        this.closeEvent();
      }

      isActionCompleted($contents) {
        const contentsPathName = $contents[0].location.pathname;
        if (RegExp(issuePathname + "$").test(contentsPathName)) {
          // Copy notice bar
          const contentsNoticeBar = $contents.find("#flash_notice.notice");
          if (contentsNoticeBar.length > 0) {
            $("#flash_notice").remove();
            $("#content").prepend(contentsNoticeBar);
          }
          return 2;
        } else if (/issues\/new$/.test(contentsPathName)) {
          if ($contents.find("#flash_notice.notice").length > 0) {
            // Create and add another
            return 1;
          } else {
            // Continue editing
            return 0;
          }
        } else if (
          RegExp("/" + this.dialogContentType + "$").test(contentsPathName)
        ) {
          if ($contents.find("#errorExplanation").length > 0) {
            // Continue editing
            return 0;
          }
        }
      }

      prepareDialog($contents) {
        $contents.find("#parent_issue>input").prop({ readonly: true });
        $contents.find('#issue-form>input[type="submit"]').hide();
        const $cancelButton = $contents
          .find("form input[type=submit]+a")
          .on("click", (e) => {
            this.closeEvent();
            e.preventDefault();
            e.stopPropagation();
          });
      }

      createSubmitButtons($contents) {
        const submitButtons = $contents
          .find('#issue-form>input[type="submit"]')
          .toArray()
          .map((element) => {
            return {
              text: $(element).val(),
              click: () => {
                $(element).click();
              },
            };
          });
        if (submitButtons.length > 0) {
          this.appendButtons(submitButtons);
        }

        // Redirect the page if "Create and follow" button is clicked.
        $contents
          .find('#issue-form>input[type="submit"][name="follow"]')
          .on("click", () => {
            $contents.find("#issue-form").attr("target", "_top");
          });
      }
    }

    class EditAttachmentsDialog extends IframeDialog {
      constructor(config = {}) {
        super({ width: 980, height: 540, modal: true, ...config });
        this.dialogContentType = "edit_attachments";
        this.dialogId = "edit-attachments-dialog";
      }

      updateAttachments() {
        $.ajax({ url: issueUrl, dataType: "html" }).done((data) => {
          $("#content .attachments>table").remove();
          $("#content .attachments>.contextual").after(
            $("#content .attachments>table", data)
              .css({ maxHeight: 100 })
              .addClass(this.resizableAttachmentTableEnabled ? "resizable" : "")
          );
          issueLayoutManager?.resetHeightOfAttachmentTable();
        });
      }

      onActionComplete($contents) {
        this.closeEvent();
        this.updateAttachments();
      }

      isActionCompleted($contents) {
        const contentsPathName = $contents[0].location.pathname;
        if (/\/issues\/[0-9]+(|\/|\?.+)$/.test(contentsPathName)) {
          // Completed
          return 2;
        } else if (RegExp(this.url + "$").test(contentsPathName)) {
          // Continue editing
          return 0;
        }

        // Is another page (Create and follow)
        return -1;
      }

      prepareDialog($contents) {
        $contents.find('#content input[type="submit"]').parent().hide();
        const $cancelButton = $contents
          .find("form div.box.attachments+p input[type=submit]+a")
          .on("click", (e) => {
            this.closeEvent();
            e.preventDefault();
            e.stopPropagation();
          });

        // Additional style
        $contents.find("head").append(
          $("<style>").text(`
              #content > form > .box.attachments {
                overflow-x: auto;

                &>table {
                  width: max(700px, 100%);

                  tr {
                    display: flex;

                    td:has(input[id$="description"]) {
                      flex: 1 1 auto;

                      input { width: 100%; }
                    }
                  }
                }
              }
              `)
        );
      }

      createSubmitButtons($contents) {
        const $attachmentsSubmitButton = $contents.find(
          "form div.box.attachments+p input[type=submit]"
        );
        if ($attachmentsSubmitButton.length > 0) {
          this.appendButtons([
            {
              text: $attachmentsSubmitButton.val(),
              click: () => {
                $attachmentsSubmitButton.click();
              },
            },
          ]);
        }
      }
    }

    class TimeEntryDialog extends IframeDialog {
      constructor(config = {}) {
        super({ width: 500, height: 640, modal: true, ...config });
        this.dialogContentType = "time_entries";
        this.dialogId = "time-entries-dialog";
      }

      updateTimeEntry() {
        if ($("#tab-content-time_entries").length > 0) {
          $("#tab-content-time_entries").empty();
          $("#tab-time_entries").click();
          $.ajax({ url: issueUrl, dataType: "html" }).done((data) => {
            const selector = "div.issue div.attributes .spent-time.attribute";
            $(selector).empty().append($(selector, data).children());
          });
        } else {
          location.reload();
        }
      }

      onActionProgress($contents) {
        if ($("#tab-content-time_entries").length > 0) {
          this.updateTimeEntry();
        } else {
          // Update dialog close event (reload page)
          this.$dialog.dialog("option", "close", this.updateTimeEntry);
        }
      }

      onActionComplete($contents) {
        this.updateTimeEntry();
        this.closeEvent();
      }

      isActionCompleted($contents) {
        const contentsPathName = $contents[0].location.pathname;
        if (RegExp(issuePathname + "$").test(contentsPathName)) {
          // Copy notice bar
          const contentsNoticeBar = $contents.find("#flash_notice.notice");
          if (contentsNoticeBar.length > 0) {
            $("#flash_notice").remove();
            $("#content").prepend(contentsNoticeBar);
          }
          return 2;
        } else if (/\/time_entries\/.*[new|edit]$/.test(contentsPathName)) {
          if ($contents.find("#flash_notice.notice").length > 0) {
            // Create and add another
            return 1;
          } else {
            // Continue editing
            return 0;
          }
        } else if (
          RegExp("/" + this.dialogContentType + "$").test(contentsPathName)
        ) {
          if ($contents.find("#errorExplanation").length > 0) {
            // Continue editing
            return 0;
          }
        }

        // Is another page (Create and follow)
        return -1;
      }

      prepareDialog($contents) {
        $contents
          .find("#time_entry_issue_id, #time_entry_project_id")
          .prop({ disabled: true });
        const $cancelButton = $contents
          .find(
            "#content>form.new_time_entry>input[type=submit]+a, " +
              "#content>form.edit_time_entry>input[type=submit]+a"
          )
          .hide()
          .on("click", (e) => {
            this.closeEvent();
            e.preventDefault();
            e.stopPropagation();
          });
      }

      createSubmitButtons($contents) {
        const submitButtons = $contents
          .find(
            "#content>form.new_time_entry>input[type=submit], " +
              "#content>form.edit_time_entry>input[type=submit]"
          )
          .hide()
          .on("submit", (e) => {
            $contents
              .find("#time_entry_issue_id, #time_entry_project_id")
              .prop({ disabled: false });
          })
          .toArray()
          .map((element) => {
            return {
              text: $(element).val(),
              click: () => {
                $(element).click();
              },
            };
          });
        if (submitButtons.length > 0) {
          this.appendButtons(submitButtons);
        }
      }
    }

    // Dialog manager class
    class DialogManager {
      constructor(
        enableAddChildIssueDialog,
        enableEditAttachmentsDialog,
        enableTimeEntryDialog
      ) {
        this.addChildIssueDialog = null;
        this.editAttachmentsDialog = null;
        this.timeEntryDialog = null;

        if (enableAddChildIssueDialog) {
          this.#setupAddChildIssueDialog();
        }
        if (enableEditAttachmentsDialog) {
          this.#setupEditAttachmentsDialog();
        }
        if (enableTimeEntryDialog) {
          this.#setupTimeEntryDialog();
        }
      }

      #setupAddChildIssueDialog() {
        if (this.addChildIssueDialog !== null) return;
        this.addChildIssueDialog = new AddChildIssueDialog();

        // Replace child-issue-add link action
        $("#content")
          .off("click.addChildIssueDialog", "#issue_tree>.contextual>a")
          .on("click.addChildIssueDialog", "#issue_tree>.contextual>a", (e) => {
            e.preventDefault();
            this.addChildIssueDialog.open($(e.target).attr("href"));
          })
          .addClass("prevent-popup-anywhere");
      }

      #setupEditAttachmentsDialog() {
        if (this.editAttachmentsDialog !== null) return;
        this.editAttachmentsDialog = new EditAttachmentsDialog();

        // Replace attachments-edit link action
        $("#content")
          .off(
            "click.editAttachmentsDialog",
            '.attachments .contextual a[href$="edit"]'
          )
          .on(
            "click.editAttachmentsDialog",
            '.attachments .contextual a[href$="edit"]',
            (e) => {
              e.preventDefault();
              this.editAttachmentsDialog.open(
                $(e.target).attr("href"),
                $(e.target).text()
              );
            }
          )
          .find('.attachments .contextual a[href$="edit"]')
          .addClass("prevent-popup-anywhere");
      }

      #setupTimeEntryDialog() {
        if (this.timeEntryDialog !== null) return;
        this.timeEntryDialog = new TimeEntryDialog();

        // Replace time_entries add link
        $('#content .contextual a[href$="/time_entries/new"]')
          .off("click.timeEntryDialog")
          .on("click.timeEntryDialog", (e) => {
            e.preventDefault();
            this.timeEntryDialog.open(
              $(e.target).attr("href"),
              $(e.target).text()
            );
          })
          .addClass("prevent-popup-anywhere");

        // Replace time_entries edit link in history
        $("#tab-content-time_entries")
          .off("click.timeEntryDialog", '.contextual a[href$="/edit"]')
          .on("click.timeEntryDialog", '.contextual a[href$="/edit"]', (e) => {
            e.preventDefault();
            this.timeEntryDialog.open(
              $(e.target).attr("href"),
              $(e.target).text()
            );
          });
      }
    }

    class NotesDialog extends BaseDialog {
      constructor(config = {}, dependencies = {}) {
        const notesDialogConfig = {
          title: resources.labelAddQuickNotes,
          autoOpen: false,
          position: { my: "left+100 top+200", at: "left top", of: window },
          buttons: [
            {
              text: resources.labelSubmitQuickNotesWithAttachments,
              click: asyncAjaxSubmitNotesWithAttachments,
            },
            {
              text: resources.labelSubmitAll,
              click: () => {
                $("#issue-form").submit();
              },
              title: resources.messageSubmitAll,
            },
          ],
          open: () => {
            if (issueLayoutManager.tabViewEnabled) {
              if (
                issueLayoutManager.$issueContainer.find("#update").length === 0
              ) {
                console.warn("Edit form is not found.");
                return;
              }
            }

            // Reset history and quickNotes2 height
            $history.css("height", "");
            if (this.quickNotes2) this.quickNotes2.resetHeight();

            const $dialogCloseButton = this.$dialogRoot.find(
              ".ui-dialog-titlebar-close"
            );

            // Open notes dialog
            if (
              (issueLayoutManager.tabViewEnabled &&
                $("#tab-issue-view").hasClass("selected")) ||
              (!issueLayoutManager.tabViewEnabled &&
                !$("#update").is(":visible"))
            ) {
              this.$dialog.dialog("option", "appendTo", "#content");
              $("#update").appendTo(this.$dialog).show();

              // Setup dialog close button
              $dialogCloseButton
                .button({ icon: "ui-icon-closethick" })
                .attr("title", resources.labelClose);
            } else {
              this.$dialog.dialog(
                "option",
                "appendTo",
                "#issue-form > .box.filedroplistner"
              );
              $("<div>")
                .addClass("box")
                .addClass("filedroplistner")
                .on({
                  dragover: dragOverHandler,
                  dragleave: dragOutHandler,
                  drop: handleFileDropEvent,
                })
                .append($("#add_notes"))
                .append($("#add_attachments"))
                .appendTo(this.$dialog);

              // Setup dialog close button
              $dialogCloseButton
                .button({ icon: "ui-icon-arrowreturnthick-1-s" })
                .attr("title", resources.labelRestore);
            }

            // Reset position
            this.$dialog.dialog(
              "option",
              "position",
              this.$dialog.dialog("option", "position")
            );

            issueLayoutManager?.updateSubmitButtonPosition();

            $("#issue_notes").focus();
          },
          beforeClose: () => {
            this.backupDocumentScrollPosition();
          },
        };

        super({
          ...notesDialogBaseConfig,
          ...notesDialogConfig,
          ...config,
        });
        this.quickNotes2 = dependencies.quickNotes2;
        this.enableInlineNotes = dependencies.enableInlineNotes;
        this.dialogId = "notes-dialog";
        this.isOpenedFromInlineNotes = false; // default value
        this.setupDialog();

        this.#replaceUpdateIssueFromFunction();
        this.#replaceShowAndScrollToFunction();
      }

      open(isOpenedFromInlineNotes = false) {
        super.open();
        this.isOpenedFromInlineNotes = isOpenedFromInlineNotes;
      }

      setupDialog() {
        if (this.$dialog !== null) return;
        const $notesDialog = $("<div>").attr("id", "notes-dialog-content");
        this.$dialog = $notesDialog.dialog(this.config);
        this.$dialogRoot = this.$dialog.parent();
      }

      createEvent() {
        super.createEvent();
        setTimeout(() => {
          this.$dialogRoot.css({ position: "fixed" });
          this.appendButtonToDialogTitlebar();
        });
      }

      closeEvent() {
        if (issueLayoutManager.tabViewEnabled) {
          if ($("#tab-issue-view").hasClass("selected")) {
            $("#update").hide();
          }
        } else if ($("#update").closest("#notes-dialog").length > 0) {
          $("#update").hide();
        }

        issueLayoutManager.resetForm();

        // Clear dialog contents
        $("#notes-dialog-content").empty();

        // Scroll to backed up scroll position
        $(document).scrollLeft(this.documentScrollPosition.left);
        $(document).scrollTop(this.documentScrollPosition.top);

        issueLayoutManager?.updateSubmitButtonPosition();

        if (this.isOpenedFromInlineNotes) {
          this.enableInlineNotes();
        }
      }

      appendButtonToDialogTitlebar() {
        const $titleBar = this.$dialogRoot.find(".ui-dialog-titlebar");

        const $btnToggleFixed = $("<button>")
          .attr("type", "button")
          .addClass("notes-dialog-titlebar-button")
          .addClass("notes-dialog-toggle-fixed-position")
          .button({
            // Default position is "fixed"
            icon: "ui-icon-pin-w",
            label: resources.labelUnfixed,
            showLabel: false,
          })
          .click((e) => {
            e.preventDefault();
            const currentContent = this.$dialog.dialog("option", "appendTo");
            const baseContent = "#content";
            const contentPosition = {
              left:
                $(currentContent).offset().left -
                $(baseContent).offset().left -
                ($(currentContent).position().left -
                  $(baseContent).position().left),
              top:
                $(currentContent).offset().top -
                $(baseContent).offset().top -
                ($(currentContent).position().top -
                  $(baseContent).position().top),
            };

            if (this.$dialogRoot.css("position") !== "fixed") {
              // Set position to fixed
              this.$dialogRoot.css({
                position: "fixed",
                left:
                  this.$dialogRoot.position().left -
                  $(document).scrollLeft() +
                  contentPosition.left,
                top:
                  this.$dialogRoot.position().top -
                  $(document).scrollTop() +
                  contentPosition.top,
              });
              $(e.currentTarget)
                .button("option", {
                  icon: "ui-icon-pin-w",
                  label: resources.labelUnfixed,
                })
                .attr("title", resources.labelUnfixed);
            } else {
              // Set position to absolute
              this.$dialogRoot.css({
                position: "absolute",
                left:
                  this.$dialogRoot.position().left +
                  $(document).scrollLeft() -
                  contentPosition.left,
                top:
                  this.$dialogRoot.position().top +
                  $(document).scrollTop() -
                  contentPosition.top,
              });
              $(e.currentTarget)
                .button("option", {
                  icon: "ui-icon-pin-s",
                  label: resources.labelFixed,
                })
                .attr("title", resources.labelFixed);
            }
          });

        const $btnRestore = $("<button>")
          .addClass("ui-button-issue-view-customize-restore")
          .button({
            icon: "ui-icon-newwin",
            label: resources.labelRestore,
            showLabel: false,
          })
          .click((e) => {
            e.preventDefault();
            this.$dialogRoot.removeClass("issue-view-customize-maximize");

            // Restore size
            this.$dialogRoot.resizable("enable");
            $("html").css({ overflow: "" });
          });

        const $btnMaximize = $("<button>")
          .addClass("ui-button-issue-view-customize-maximum")
          .button({
            icon: "ui-icon-stop",
            label: resources.labelMaximize,
            showLabel: false,
          })
          .click((e) => {
            e.preventDefault();
            this.$dialogRoot.addClass("issue-view-customize-maximize");
            $("html").css({ overflow: "hidden" });
            this.$dialogRoot.resizable("disable");
          });

        const $btnGroup = $("<div>")
          .addClass("ui-dialog-titlebar-button-group")
          .append($btnToggleFixed)
          .append($btnRestore)
          .append($btnMaximize)
          .appendTo($titleBar);
      }

      backupDocumentScrollPosition() {
        this.documentScrollPosition = {
          left: $(document).scrollLeft(),
          top: $(document).scrollTop(),
        };
      }

      #replaceUpdateIssueFromFunction() {
        const updateIssueFromOrg = updateIssueFrom;
        updateIssueFrom = (url, el) => {
          return updateIssueFromOrg(url, el).then(() => {
            notesManager?.addNotesDialogPopOutButton();
          });
        };
      }

      #replaceShowAndScrollToFunction() {
        const showAndScrollToOrg = showAndScrollTo;
        showAndScrollTo = function (id, focus) {
          if (id === "update") {
            if (issueLayoutManager.tabViewEnabled) {
              if (!$("#tab-issue-edit").hasClass("selected")) {
                if (!notesManager.dialogNotes.isOpen()) {
                  $("html, body").animate(
                    { scrollTop: $("#add_notes").offset().top },
                    100
                  );
                }
                return;
              }
            } else {
              if (notesManager.dialogNotes.isOpen()) {
                notesManager.dialogNotes.close();
                showAndScrollToOrg.call(this, id, focus);
                notesManager.dialogNotes.open();
                return;
              }
            }
          }
          showAndScrollToOrg.call(this, id, focus);
        };
      }
    }

    // Notes manager class
    class NotesManager {
      constructor(enableDialogNotes, enableQuickNotes2) {
        if (!isEditable) return;
        this.quickNotes2 = enableQuickNotes2
          ? new QuickNotes2(() => {
              this.enableInlineNotes();
            })
          : null;
        this.dialogNotes = enableDialogNotes
          ? new NotesDialog(
              {},
              {
                quickNotes2: this.quickNotes2,
                enableInlineNotes: () => {
                  this.enableInlineNotes();
                },
              }
            )
          : null;

        this.#setupInlineNotes();
        this.addNotesDialogPopOutButton();
      }

      enableDialogNotes(state, isOpenedFromInlineNotes = false) {
        if ($("#update").length === 0) return;
        if (!this.dialogNotes) return;

        if (state) {
          issueLayoutManager.resetForm();
          this.dialogNotes.open(isOpenedFromInlineNotes);
        } else {
          this.dialogNotes.close();
        }
      }

      enableInlineNotes() {
        if (!this.quickNotes2 || !this.quickNotes2.initialized()) return;

        this.enableDialogNotes(false);
        this.quickNotes2.show();

        // Change textarea rows
        $("#issue_notes").attr("rows", 4);

        // Change legend
        $("#add_notes>legend:first").text(resources.labelQuickNotes);

        // Add notes pop-out button
        this.addNotesDialogPopOutButton();

        // Focus to notes field
        $("#issue_notes")[0].focus();
      }

      #setupInlineNotes() {
        if (!this.quickNotes2 || !this.quickNotes2.initialized()) return;

        // Replace edit-notes link in history
        $("#history").on("click", ".journal-actions>a.icon-comment", () => {
          if (!$("#update").is(":visible")) {
            if (!$("#notes-dialog-content").dialog("isOpen")) {
              this.enableInlineNotes();
            }
          }
        });

        // Replace quoted link
        $("#issue-container").on(
          "click",
          'div.description>div.contextual>a[href$="quoted"]',
          () => {
            if (
              !$("#update").is(":visible") &&
              !$("#notes-dialog-content").dialog("isOpen")
            ) {
              this.enableInlineNotes();
            }
          }
        );
      }

      addNotesDialogPopOutButton() {
        if (!isEditable) return;
        if (!this.dialogNotes) return;

        if ($("#add_notes").length === 0) return;
        if ($("#notes-dialog-pop-out-button").length > 0) return;

        const $button = $("<span >")
          .attr("id", "notes-dialog-pop-out-button")
          .attr("title", resources.labelPopOut)
          .addClass("ui-icon")
          .addClass("ui-icon-arrowreturnthick-1-n")
          .on("click", (e) => {
            e.preventDefault();
            const isOpenedFromInlineNotes =
              $(e.target).closest("#quick_notes2").length > 0;
            issueLayoutManager.resetForm();
            this.enableDialogNotes(true, isOpenedFromInlineNotes);
          })
          .prependTo($("#add_notes>legend"));
      }
    }

    class SettingsManager {
      #settings = {};

      constructor(settings) {
        this.#settings = { ...defaultSettings, ...settings };
      }

      loadSettings() {
        // Load settings from localStorage or use default values
        const storedSettings = JSON.parse(
          localStorage.getItem("custom_issue_view_settings") ?? "{}"
        );

        Object.keys(this.#settings).forEach((key) => {
          this.#settings[key] =
            storedSettings[key] !== undefined
              ? storedSettings[key]
              : this.#settings[key];
        });
      }

      saveSettings() {
        // Save settings to localStorage
        localStorage.setItem(
          "custom_issue_view_settings",
          JSON.stringify(this.#settings)
        );
      }

      getSetting(key) {
        return this.#settings[key];
      }

      setSetting(key, value) {
        this.#settings[key] = value;
      }

      get settings() {
        return this.#settings;
      }
    }

    class SettingsPanel extends BaseDialog {
      constructor(settingsManager, config = {}) {
        super({
          title: resources.labelCustomIssueViewSettings,
          width: 400,
          height: 450,
          modal: true,
          autoOpen: false,
          ...config,
        });
        this.settingsManager = settingsManager;
        this.dialogId = "custom-issue-view-settings-panel";
        this.setupSettingsMenu();
        this.setupDialog();
      }

      setupSettingsMenu() {
        const $settingsMenuItem = $("<a>")
          .addClass("custom-issue-view-settings-menu-item icon icon-settings")
          .text(resources.labelIssueViewSettings)
          .on("click", (e) => {
            e.preventDefault();
            this.open();
          })
          .css({
            cursor: "pointer",
          })
          .appendTo("#content>.contextual .drdn-items");
      }

      setupDialog() {
        if (this.$dialog !== null) return;

        this.$settingsPanel = $("<div>").attr(
          "id",
          "custom-issue-view-settings-panel-content"
        );
        this.$dialog = this.$settingsPanel.dialog(this.config);
        this.$dialogRoot = this.$dialog.parent();

        this.appendButtons([
          {
            text: resources.labelSaveAndReload,
            click: () => {
              this.saveAndReload();
            },
          },
          {
            text: resources.labelCancel,
            click: () => {
              this.$dialog.dialog("close");
            },
          },
        ]);
      }

      open() {
        super.open();
        this.loadSettingsToPanel(this.settingsManager.settings);
      }

      loadSettingsToPanel(settings) {
        this.$settingsPanel.empty();

        Object.keys(settings).forEach((key) => {
          const value = settings[key];
          const defaultValue = defaultSettings[key];
          const $input = $("<input>").attr("id", `setting-${key}`);

          if (typeof defaultValue === "boolean") {
            $input.attr("type", "checkbox").prop("checked", value);
          } else if (key === "sideBySideModeBreakpointWidth") {
            $input.attr({ type: "number", min: 0, step: 1 }).val(value);
          } else if (typeof defaultValue === "number") {
            $input.attr("type", "number").val(value);
          } else {
            $input.attr("type", "text").val(value);
          }

          const resourceLabelKey = `labelSetting${key
            .charAt(0)
            .toUpperCase()}${key.slice(1)}`;
          const resourceMessageKey = `messageSetting${key
            .charAt(0)
            .toUpperCase()}${key.slice(1)}`;
          const $label = $("<label>")
            .attr("for", `setting-${key}`)
            .attr("title", resources[resourceMessageKey] ?? "")
            .text(
              resources[resourceLabelKey] ??
                key.replace(/([A-Z])/g, " $1").trimStart()
            );
          const $settingItem = $("<div>").addClass("setting-item");

          if (typeof defaultValue === "boolean") {
            $settingItem.append($input).append($label);
          } else {
            $settingItem.append($label).append($input);
          }
          this.$settingsPanel.append($settingItem);
        });
      }

      saveAndReload() {
        // Save settings from panel
        Object.keys(this.settingsManager.settings).forEach((key) => {
          const defaultValue = defaultSettings[key];

          const $input = $(`#setting-${key}`);
          if (typeof defaultValue === "boolean") {
            const isChecked = $input.is(":checked");
            this.settingsManager.setSetting(key, isChecked);
          } else if (typeof defaultValue === "number") {
            const inputValue = $input.val();
            const numberValue = Number(inputValue);
            this.settingsManager.setSetting(
              key,
              isNaN(numberValue) ? 0 : numberValue
            );
          } else {
            this.settingsManager.setSetting(key, $input.val());
          }
        });
        this.settingsManager.saveSettings();

        // Reload page to apply settings
        location.reload();
      }

      closeEvent() {}
    }

    async function asyncAjaxSubmitNotesWithAttachments() {
      const url = $("#issue-form").attr("action");

      // Serialize basic information
      const formData =
        $("#issue-form")
          .find("input, textarea")
          .filter((_, e) =>
            ["utf8", "_method", "authenticity_token"].includes(
              $(e).attr("name")
            )
          )
          .serialize() +
        "&" +
        $("#issue_notes").serialize() +
        "&" +
        $("#new-attachments input").serialize();

      // Post data
      await new Promise((resolve, reject) => {
        $.ajax({
          url: url,
          type: "post",
          data: formData,
          dataType: "html",
        })
          .done((data) => {
            // Clear form
            $("#issue_notes").val("").removeData("changed");
            $("#new-attachments .attachments_fields").empty();

            issueLayoutManager.updateFormCore(data, !enableRedmineRT);

            // Change tab to edit
            $("#add_notes .tab-edit")[0].click();

            if (!enableRedmineRT) {
              issueLayoutManager?.resetHeightOfAttachmentTable();
            }
            resolve(data);
          })
          .fail((res) => {
            alert(resources.messageFailedToSend);
            reject(res);
          });
      });
    }

    ajaxUpdateIssueList = async function (settings) {
      const settingsDefault = {
        search: location.search,
        noSearch: false,
        target: undefined,
      };
      settings = { ...settingsDefault, ...settings };

      settings.search = settings.noSearch
        ? ""
        : settings.search[0] === "?"
        ? settings.search
        : "?" +
          (settings.search[0] === "&"
            ? settings.search.slice(1)
            : settings.search);

      const url = location.origin + location.pathname + settings.search;

      await $.ajax({ url: url, dataType: "html" }).done((data) => {
        issueLayoutManager.updateFormCore(data);
      });
    };

    function initialize() {
      const settingsManager = new SettingsManager();
      settingsManager.loadSettings();

      const settingsPanel = new SettingsPanel(settingsManager);

      issueLayoutManager = new IssueLayoutManager(
        settingsManager.settings.enableIssueTabView,
        settingsManager.settings.enableSideBySideMode,
        settingsManager.settings.enableFloatingSubmitButton,
        settingsManager.settings.enableResizableAttachmentTable,
        settingsManager.settings.enableCorrectAttributesPositionInEditView,
        settingsManager.settings.isDescriptionEditFieldOpenByDefault,
        settingsManager.settings.sideBySideModeBreakpointWidth
      );

      if (isEditable) {
        notesManager = new NotesManager(
          settingsManager.settings.enablePopupNotes,
          settingsManager.settings.enableInlineNotes
        );

        const dialogManager = new DialogManager(
          settingsManager.settings.enableAddChildIssueDialog,
          settingsManager.settings.enableEditAttachmentsDialog,
          settingsManager.settings.enableTimeEntryDialog
        );

        // Fix height of wiki-preview with scrollbar
        // Override jsToolBar.showPreview function
        const jsToolBarShowPreviewOrg = jsToolBar.prototype.showPreview;
        jsToolBar.prototype.showPreview = function (event) {
          const textareaHeight = $(this.textarea).outerHeight();
          jsToolBarShowPreviewOrg.call(this, event);
          if (textareaHeight > 0) {
            // TODO:
            // this.preview.setAttribute(
            //   "style",
            //   "height: " + textareaHeight + "px;"
            // );
            $(this.preview).css({
              height: textareaHeight,
              minHeight: textareaHeight,
              boxSizing: "border-box",
            });
          }
        };

        // Show RedmineRT QuickNotes -> discontinue
        // $("#quick_notes").slideDown();
      }
    }

    initialize();
  });
</script>
<style>
  /* CSS variables for consistent values */
  :root {
    --border-standard: 1px solid #dfe8f1;
    --attachment-table-max-height: 100px;
    --resizable-handle-color: #759fcf99;
  }

  /* Hide issue edit cancel button in issue tab view */
  #content.issue-tab-view-enabled #issue-form input[type="submit"] + a {
    display: none;
  }

  #side-by-side-switch-box {
    display: none;
    margin: 0 10px;
  }

  #issue-container {
    & > div.tabs {
      width: 100%;
      margin: 0;
    }

    & > div.issue {
      border: var(--border-standard);
      border-top: 0;
      margin: 0;
    }
  }

  :where(#content.issue-tab-view-enabled, #notes-dialog-content) #update {
    margin-bottom: 2em;

    /* Hide edit title */
    & > h3:nth-of-type(1) {
      display: none;
      margin: 0;
      padding: 10px;
      border-left: var(--border-standard);
      border-right: var(--border-standard);
      background: #fff;
    }

    form.edit_issue > div.box {
      border-top: 0;
    }
  }

  #notes-dialog-content #update div.box fieldset.tabular {
    display: none;
  }

  #wrapper.side-by-side {
    #container ~ div.contextual {
      display: none;
    }

    #container ~ p.other-formats {
      display: none;
    }
  }

  #issue-container.ui-resizable > .ui-resizable-handle {
    display: none;
  }

  #parent_issue {
    clear: none;
    margin-bottom: 6px;
  }

  @media screen and (max-width: 899px) {
    .header_attribute
      :where(select, input, input#issue_subject, input#document_title),
    #all_attributes .header_attribute select#issue_tracker_id {
      width: 100%;
    }

    #parent_issue {
      float: left;
    }

    #content > .contextual > a.icon-comment,
    #notes-dialog-pop-out-button {
      display: none;
    }
  }

  @media screen and (min-width: 900px) {
    .header_attribute :where(select, input) {
      max-width: 100%;
    }

    .header_attribute_float-left {
      float: left;
    }

    .header_attribute_float-right {
      float: right;
    }

    #parent_issue {
      clear: right;
      float: right;
    }
  }

  #wrapper:not(.side-by-side-mode-enabled) #main {
    /* Disable side-by-side mode */
    #issue-container {
      width: 100% !important;
    }

    #quick_notes2 {
      height: auto !important;

      /* Hide resize handle if side-by-side mode is not enabled */
      & > .ui-resizable-handle {
        display: none !important;
      }
    }
  }

  #wrapper.side-by-side-mode-enabled {
    #side-by-side-switch-box {
      display: inline;
      & > * {
        cursor: pointer;
      }
    }

    &.side-by-side {
      height: 100vh;

      #top-menu,
      #header {
        flex: 0 0 auto;
      }

      #main {
        flex: 1 1 auto;
        overflow: hidden;
      }

      #container {
        display: grid;
        grid-template: "issue-container history-container" 100% / min-content 1fr;
        height: calc(100% - 50px);
        #issue-container {
          resize: horizontal;
          grid-area: issue-container;
          width: 800px;
          min-width: 450px;
          display: flex;
          flex-direction: column;
          & > div.issue {
            max-height: 100%;
            overflow: auto;
          }
          & > .tabs {
            flex: 0 0 auto;
          }
          & > div.ui-resizable-handle {
            display: block;
          }
        }
        #update {
          margin-bottom: 0;
          overflow: hidden;
          flex: 1 1 auto;

          form.edit_issue > div.box {
            max-height: 100%;
            overflow: auto;
            box-sizing: border-box;
            margin: 0;
          }
        }

        #history-container {
          margin-left: 10px;
          margin-right: 10px;
          grid-area: history-container;
          min-width: 350px;
          width: calc(100% - 10px);
          display: flex;
          flex-direction: column;
          overflow: hidden;
        }
        #history {
          height: 100%;
          overflow: hidden;
          flex: 1 1 auto;

          &[data-comment_sorting="desc"] {
            flex: 1 1 auto;
          }

          & > .tabs {
            flex: 0 0 auto;
            margin-bottom: 0;
          }

          & > .tab-content {
            max-height: calc(100% - 40px); /* TODO: -40px */
            box-sizing: border-box;
            overflow: auto;
            margin: 0;
            padding: 10px;
          }
        }

        /* Support for RedmineRT */
        #quick_notes {
          grid-area: quick_notes;
          flex: 1 1 auto;

          fieldset {
            height: 100%;
            box-sizing: border-box;
            textarea.wiki-edit {
              height: calc(100% - 40px) !important;
              resize: none;
            }
          }

          /* If the history is sorted in descending order */
          &:first-child {
            flex: 0 0 auto;
          }
        }

        #quick_notes2 {
          flex: 0 0 auto;

          #issue_notes:not(.hidden) {
            height: 100% !important;
            resize: none;
          }
        }
      }

      #issue-form
        :where(input[type="submit"], .save-draft-button):not(.fixed-position) {
        margin-top: -83px;
      }
    }

    &:not(.side-by-side) {
      #quick_notes2 {
        height: auto !important;

        & > .ui-resizable-handle {
          display: none !important;
        }
      }
    }
  }

  #quick_notes2 {
    background-color: #f4f7f9;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: stretch;
    border-radius: 3px;
    margin: 0;
    padding: 5px;
    /* Prevent the change of the top by Resizable event */
    top: 0 !important;

    &:hover,
    &:has(#add_notes) {
      padding: 10px;
    }

    & > div.box {
      flex: 1 1 auto;
      overflow: auto;
      padding: 0;
      margin: 0;
      border: 0;
      display: flex;
      flex-direction: column;
      background-color: inherit;
    }

    #add_notes {
      flex: 1 1 auto;
      height: 100%;

      .jstBlock {
        height: calc(100% - 30px);
        position: relative;

        .jstEditor {
          height: calc(100% - 35px);
          position: relative;

          .wiki-preview {
            box-sizing: border-box;
          }
        }
      }
    }

    &.fileover {
      background-color: lavender;
    }
  }

  #quick_notes2-buttons {
    display: flex;
    justify-content: space-between;
  }
  #issue-form-buttons {
    text-align: right;
  }
  #quick_notes2-open-button,
  #quick_notes2-close-button,
  #quick_notes2-submit-button,
  #restore-notes-pane-button {
    cursor: pointer;
    margin: 0;
    color: #999;
    height: auto;

    &:hover {
      font-weight: bold;
      color: #444;
    }
  }
  #quick_notes2-open-button {
    display: none;
    width: 100%;
    background-color: transparent;

    &:hover {
      background-color: #fff;
    }
  }
  #quick_notes2:hover:not(:has(#add_notes)) #quick_notes2-open-button {
    display: block;
  }
  #quick_notes2-close-button,
  #quick_notes2-submit-button {
    margin-top: 10px;
  }
  #quick_notes2:has(#add_notes) #quick_notes2-open-button,
  #quick_notes2:not(:has(#add_notes)) > div.box,
  #quick_notes2:not(:has(#add_notes))
    :is(
      #quick_notes2-close-button,
      #quick_notes2-submit-button,
      #switch-quicknotes2-position-button
    ),
  #issue-form:has(#add_notes) #restore-notes-pane-button {
    display: none;
  }

  #quick_notes2:not(:has(#add_notes)) .ui-resizable-handle {
    display: none !important;
  }

  #switch-quicknotes2-position-button {
    position: absolute;
    top: 0;
    right: 0;
    cursor: pointer;
    transform: rotate(90deg);
    margin: 3px;
    opacity: 0.3;

    &:hover {
      opacity: 1;
    }
  }

  /* Support for RedmineRT */
  #quick_notes {
    /* Initial state for anti-flicker */
    display: none;
    margin: 10px 0;
  }

  #issue-container > .ui-resizable-handle {
    height: calc(100% - 34px);
    top: 34px;
  }

  :where(#issue-container, #quick_notes2) > .ui-resizable-handle {
    border-radius: 3px;
    &:hover {
      background-color: var(--resizable-handle-color);
    }
  }

  .ui-dialog {
    box-shadow: rgba(0, 0, 0, 0.2) 0px 0px 10px;
  }

  /* Fix height of the dialog button */
  .ui-dialog.issue-view-customize
    > div.ui-dialog-buttonpane
    div.ui-dialog-buttonset
    button {
    height: auto;
  }

  #notes-dialog {
    &:not(.ui-dialog-resizing):not(.ui-dialog-dragging):not(
        .ui-dialog-position-changing
      ) {
      transition: width 0.5s, height 0.5s, top 0.5s, left 0.5s;
    }

    & > .ui-dialog-titlebar {
      & > button.notes-dialog-titlebar-button {
        position: absolute;
        top: 50%;
        width: 20px;
        margin: -10px 0 0 0;
        padding: 1px;
        height: 20px;
      }

      & > button.notes-dialog-toggle-fixed-position {
        right: 25px;
      }
    }

    .ui-dialog-titlebar-button-group {
      position: absolute;
      right: 30px;
      height: 20px;
      top: 50%;
      margin-top: -10px;
      display: inline-flex;

      button {
        width: 20px;
        height: 20px;
        padding: 0;
        margin-top: 0;
        margin-bottom: 0;
      }
    }
  }

  .ui-dialog {
    &:not(.issue-view-customize-maximize)
      .ui-dialog-titlebar-button-group
      > button.ui-button-issue-view-customize-restore {
      display: none;
    }

    &.issue-view-customize-maximize {
      width: 100% !important;
      height: 100% !important;
      box-sizing: border-box !important;
      top: 0 !important;
      left: 0 !important;
      position: fixed !important;
      display: flex;
      flex-direction: column;

      .ui-dialog-content {
        flex: 1 1 auto;
        width: 100% !important;
        height: auto !important;
      }

      .ui-dialog-titlebar-button-group
        > button.ui-button-issue-view-customize-maximum {
        display: none;
      }
    }

    .ui-dialog-title {
      line-height: normal;
    }
  }

  textarea#issue_notes:not(.hidden) {
    display: block;
    min-height: 60px;
  }

  /* Notes dialog style settings */
  #notes-dialog-content {
    display: flex;
    flex-direction: column;

    #add_notes {
      background: none;
      border: 0;
      padding: 0;

      & > legend {
        display: none;
      }
    }

    #issue-form input[type="submit"] {
      display: none;

      /* Always hide the cancel button */
      & + a {
        display: none;
      }
    }

    .save-draft-button {
      display: none;
    }

    #new-attachments .add_attachment {
      font-size: unset;
    }

    /* Automatically adjust the height of the textarea in the notes dialog */
    #update {
      margin: 0;
      height: 100%;
    }

    #update form.edit_issue > div.box,
    & > div.box {
      padding: 0;
      border: 0;
      background: none;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;

      /* Countermeasure for the suspected incorrect height calculation
        when the dialog content is switched, including margins. */
      margin: 0;
    }

    #add_notes {
      flex: 1;

      .jstBlock {
        /* note: 30px is private notes checkbox height + space */
        height: calc(100% - 30px);
      }

      .jstEditor {
        /* note: 30px is private notes checkbox height + space */
        height: calc(100% - 30px);

        textarea,
        .wiki-preview {
          height: 100% !important;
          resize: none;
        }
      }
    }

    &:has(.box.filedroplistner.fileover) {
      background-color: lavender;
    }
  }

  #notes-dialog-pop-out-button {
    cursor: pointer;
    opacity: 0.3;
    float: right;
    margin: auto;

    &:hover {
      opacity: 1;
    }
  }

  /* Settings for time-entries-dialog and attachments-dialog and
  add-child-issue dialog */
  :is(#time-entries-dialog, #edit-attachments-dialog, #add-child-issue-dialog)
    .ui-dialog-content {
    margin: auto;
    padding: 0;
    overflow: hidden;

    iframe {
      width: 100%;
      height: 100%;
      border: 0;
    }
  }

  /* Add shade to the attachments area and also limits the height */
  div.issue > div.attachments > table.resizable {
    background-color: rgba(0, 0, 0, 0.02);
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 5px;
    display: block;
    overflow: auto;
    resize: vertical;
    max-height: var(--attachment-table-max-height);
  }

  #issue-form.enable-floating-submit-button {
    /* Submit button space */
    & > div.box {
      padding-bottom: 120px;
    }

    input[type="submit"],
    .save-draft-button {
      position: absolute;
      border-radius: 50%;
      width: 70px;
      height: 70px;
      box-shadow: 0 0 10px 0px rgb(0 0 0 / 50%);
      z-index: 6;
      margin-left: 20px;

      &.fixed-position {
        position: fixed;
        margin-top: 0;
        bottom: 60px;
        opacity: 0.5;

        &:hover {
          opacity: 1;
        }
      }

      &:not(.fixed-position) {
        margin-top: -100px;
        box-shadow: none;
      }
    }

    .save-draft-button ~ input[type="submit"] {
      left: 80px;
      &.fixed-position {
        left: 96px;
      }
    }
  }

  #content:not(.issue-tab-view-enabled)
    #issue-form.enable-floating-submit-button
    .save-draft-button
    ~ input[type="submit"] {
    left: 96px;
  }

  #content #enableSideBySideMode {
    margin-left: 10px;
    margin-right: 5px;
  }

  /* Prevent tooltip flickering on dialog */
  #notes-dialog > .ui-tooltip {
    width: max-content;
  }

  /* Fix jsToolbar item z-indices */
  /* jsToolBar table generator */
  table.table-generator {
    z-index: 200;
  }

  /* jsToolBar code highlight option */
  body > ul.ui-menu {
    z-index: 200;
  }

  /* Support Redmine theme Bleuclair */
  body.theme-Bleuclair {
    #update #issue-form.enable-floating-submit-button > div.box {
      padding-bottom: 90px;
    }
    #issue-form.enable-floating-submit-button
      :where(input[type="submit"], .save-draft-button):not(.fixed-position) {
      margin-top: -110px;
    }

    #wrapper.side-by-side-mode-enabled.side-by-side
      #issue-form
      :where(input[type="submit"], .save-draft-button):not(.fixed-position) {
      margin-top: -80px;
    }
  }

  /* Support for RedmineRT */
  .quick_notes_tooltip.ui-tooltip {
    opacity: 0.8;
  }

  /* Fix attachment field */
  #new-attachments {
    width: 100%;
  }
  :is(.attachments_fields, #existing-attachments) > span {
    display: flex;
    overflow-x: auto;
    align-items: center;
  }
  #existing-attachments label {
    margin-left: 5px;
  }

  /* Fix height of wiki-preview with scrollbar */
  .wiki-preview {
    overflow: auto;
  }

  @media print {
    #quick_notes2 {
      display: none;
    }
    #issue-container {
      width: 100% !important;

      & > div.issue {
        display: block !important;
        border-top: var(--border-standard);
      }
      & > div#update,
      & > .tabs {
        display: none !important;
      }
    }
    #main {
      margin-top: 0 !important;
    }
  }

  #custom-issue-view-settings-panel-content {
    label {
      margin-right: 0.5em;
    }
    #setting-sideBySideModeBreakpointWidth {
      width: 6em;
    }
  }

  /* Support RTL */
  html[dir="rtl"],
  html:has(head link[rel="stylesheet"][href*="/rtl"]) {
    #switch-quicknotes2-position-button {
      right: auto;
      left: 0;
    }
    #notes-dialog .ui-dialog-titlebar-button-group {
      right: auto;
      left: 30px;
    }
    #issue-container {
      left: 0 !important;
    }
    #issue_is_private_wrap {
      margin-right: 0;
      margin-left: 1em;
      padding-right: 0;
    }
    @media screen and (max-width: 899px) {
      #parent_issue {
        float: right;
      }
    }
    @media screen and (min-width: 900px) {
      #parent_issue {
        clear: left;
        float: left;
      }
    }
  }
</style>
